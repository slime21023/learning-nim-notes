# 參考與指標

Nim 提供兩種用於操作記憶體的型別：**參考型別 (`ref`)** 和 **指標型別 (`ptr`)**。這兩種型別分別適用於高階與低階的記憶體操作，並在不同層面提供靈活性與控制能力。

## 參考型別

### 使用 `ref` 定義參考

`ref` 是 Nim 中的參考型別，用於在記憶體中動態分配物件。所有 `ref` 型別的物件都由垃圾回收機制 (Garbage Collection, GC) 自動管理，開發者無需手動釋放記憶體。

範例：

```nim
type Person = ref object
  name: string
  age: int

var p: Person = Person(name: "Alice", age: 30)
echo p.name  # 輸出：Alice
p.age = 31
echo p.age   # 輸出：31
```

`p` 是一個參考型別的變數，指向一個動態分配的 `Person` 物件。


### 參考的應用場景

#### 動態資料結構  
使用 `ref` 型別可以建構如鏈結串列、樹或圖等動態資料結構。

```nim
type Node = ref object
  value: int
  next: Node

var head: Node = Node(value: 1, next: nil)
head.next = Node(value: 2, next: nil)
echo head.next.value  # 輸出：2
```

#### 共享資料  
多個變數可以共享同一個參考型別的物件，進行資料共享或同步操作。

### 參考的限制
- **不可直接比較**： 參考變數只能比較是否為 `nil`，但無法直接比較兩個參考是否指向相同的物件。
- **需要垃圾回收**： 由於 `ref` 型別依賴垃圾回收機制，因此在即時性要求高的場景（如嵌入式系統）中可能不適用。


## 指標型別

### 使用 `ptr` 定義指標

`ptr` 是 Nim 用於低階記憶體操作的型別，類似於 C 語言中的指標。指標允許直接操作記憶體地址，適合用於高效能或系統層級的程式設計。

範例：

```nim
type Person = object
  name: string
  age: int

var p: ptr Person = cast[ptr Person](alloc0(sizeof(Person)))
p[].name = "Bob"
p[].age = 25
echo p[].name  # 輸出：Bob
```

使用 `alloc0` 函式分配記憶體，並透過 `p[]` 存取指標所指向的物件。

### 指標的安全性與注意事項

1. **手動記憶體管理**： 使用指標時，開發者需手動分配與釋放記憶體，否則可能導致記憶體洩漏。

```nim
dealloc(p)  # 手動釋放記憶體
```

2. **避免空指標存取**： 在操作指標時，需檢查是否為 `nil`，以避免存取空指標導致程式崩潰。

```nim
if p != nil:
  echo p[].age
```

3. **避免野指標 (Dangling Pointer)**： 若指標指向的記憶體已被釋放，則該指標成為野指標，操作它會導致未定義行為。

4. **低階操作風險**： 使用 `ptr` 型別進行低階記憶體操作時，需特別注意避免覆蓋或破壞其他記憶體區域。

### 指標的應用場景

1. **高效能運算**： 在需要直接操作記憶體的場景（如影像處理或資料流處理），指標可以提供極高的效能。
2. **與 C 語言互操作**： Nim 的指標型別與 C 語言兼容，適合用於與 C 函式庫進行整合。

範例：與 C 函式庫互動

```nim
type CInt = ptr int
var x: int = 10
var px: CInt = cast[CInt](addr x)
echo px[]  # 輸出：10
```

### **比較：參考與指標**

| 特性                 | `ref` 型別                     | `ptr` 型別                     |
|----------------------|--------------------------------|--------------------------------|
| 記憶體管理           | 垃圾回收自動管理               | 手動管理                      |
| 使用場景             | 高階資料結構、共享資料         | 低階操作、高效能需求          |
| 安全性               | 由垃圾回收保證                 | 需開發者自行保證              |
| 與 C 語言互操作       | 不適用                        | 適用                          |
| 操作靈活性           | 較低                          | 較高                          |

---

透過 `ref` 和 `ptr` 型別，Nim 提供了靈活的記憶體操作能力，滿足從高階應用到低階操作的多樣需求。開發者可根據應用場景選擇合適的型別，並注意各自的限制與風險。